<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Conectar WhatsApp</title>
  <style>
    /* Estilo Dark Mode Profissional */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #111 0%, #222 100%);
      min-height: 100vh;
      color: #eee;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    
    .container {
      width: 100%;
      max-width: 450px;
      background: rgba(30, 30, 30, 0.95);
      padding: 2rem;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
      text-align: center;
      border: 1px solid #333;
    }
    
    .logo { color: #FF6B35; font-size: 1.5rem; font-weight: 700; margin-bottom: 5px; text-transform: uppercase; }
    .subtitle { color: #888; font-size: 0.9rem; margin-bottom: 25px; }

    .qr-box {
      background: #fff;
      padding: 15px;
      border-radius: 12px;
      display: inline-block;
      margin-bottom: 20px;
      min-width: 250px;
      min-height: 250px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .qr-img { max-width: 100%; display: block; border-radius: 4px; }

    .status-badge {
      display: inline-block;
      padding: 8px 16px;
      border-radius: 50px;
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 15px;
      background: #333;
      color: #ccc;
    }
    .status-badge.waiting { background: rgba(234, 179, 8, 0.2); color: #facc15; }
    .status-badge.connected { background: rgba(34, 197, 94, 0.2); color: #4ade80; }

    .timer-bar {
      height: 4px;
      background: #333;
      border-radius: 2px;
      overflow: hidden;
      margin-top: 10px;
      width: 100%;
      max-width: 250px;
      margin: 10px auto 0;
    }
    .timer-fill { height: 100%; background: #FF6B35; width: 100%; transition: width 1s linear; }

    /* Admin Panel */
    .admin-panel { text-align: left; margin-bottom: 20px; }
    input { width: 100%; padding: 12px; margin: 8px 0; background: #222; border: 1px solid #444; color: white; border-radius: 6px; box-sizing: border-box; }
    
    button { width: 100%; padding: 12px; background: #FF6B35; color: white; border: none; font-weight: bold; border-radius: 6px; cursor: pointer; font-size: 1rem; margin-top: 10px; }
    button:hover { background: #e65a28; }
    .btn-secondary { background: #444; }
    .btn-secondary:hover { background: #555; }
    
    .hidden { display: none; }
    .link-display { background: #111; padding: 10px; border: 1px solid #333; color: #aaa; font-size: 0.8rem; word-break: break-all; margin-top: 10px; border-radius: 6px; }

    /* Debug Status Line */
    .debug-status { font-family: monospace; font-size: 0.75rem; color: #666; margin-top: 15px; border-top: 1px solid #333; padding-top: 5px; }
  </style>
</head>
<body>

  <div class="container" id="configPanel">
    <div class="logo">Gerador de Link</div>
    <div class="subtitle">Configure a reconexÃ£o para seu cliente</div>

    <div class="admin-panel">
      <label>URL da API</label>
      <input type="text" id="apiUrl" placeholder="https://automatizando.uazapi.com">
      <label>Nome da InstÃ¢ncia</label>
      <input type="text" id="apiName" placeholder="Ex: Mercado Junior">
      <label>Token da InstÃ¢ncia</label>
      <input type="password" id="apiToken" placeholder="Cole o token aqui">
    </div>

    <button onclick="generateLink()">ðŸ”— Gerar Link</button>

    <div id="resultArea" class="hidden">
      <div class="link-display" id="linkText"></div>
      <button onclick="copyLink()" class="btn-secondary">ðŸ“‹ Copiar</button>
      <button onclick="openScanner()" style="background: #22c55e;">ðŸ“² Testar Agora</button>
    </div>
  </div>

  <div class="container hidden" id="scannerPanel">
    <div class="logo">Conectar WhatsApp</div>
    <div class="subtitle" id="instanceLabel">Carregando...</div>

    <div class="status-badge waiting" id="statusBadge">Aguardando QR Code...</div>

    <div class="qr-box" id="qrContainer">
      <div style="color: #666;">ðŸ”„ Iniciando...</div>
    </div>

    <div class="timer-bar"><div class="timer-fill" id="timerBar"></div></div>
    
    <div class="debug-status" id="realTimeStatus">Status API: Aguardando verificaÃ§Ã£o...</div>
    
    <button onclick="resetView()" class="btn-secondary" style="margin-top: 20px;">â¬… Configurar Novamente</button>
  </div>

<script>
  const params = new URLSearchParams(window.location.search);
  const cfg = params.get('cfg');
  let config = {};
  let timeLeft = 30;
  let qrInterval;
  let statusInterval;

  if (cfg) {
    try {
      config = JSON.parse(atob(cfg));
      document.getElementById('configPanel').classList.add('hidden');
      document.getElementById('scannerPanel').classList.remove('hidden');
      document.querySelector('#scannerPanel .btn-secondary').style.display = 'none';
      document.getElementById('instanceLabel').textContent = config.name || 'InstÃ¢ncia';
      startConnectionLoop();
    } catch (e) { alert("Link invÃ¡lido."); }
  }

  function generateLink() {
    const url = document.getElementById('apiUrl').value.replace(/\/+$/, '');
    const name = document.getElementById('apiName').value;
    const token = document.getElementById('apiToken').value;
    if (!url || !token) return alert("Preencha URL e Token!");

    const payload = btoa(JSON.stringify({ url, name, token }));
    const link = `${window.location.href.split('?')[0]}?cfg=${payload}`;
    document.getElementById('linkText').textContent = link;
    document.getElementById('resultArea').classList.remove('hidden');
    config = { url, name, token };
  }

  function copyLink() { navigator.clipboard.writeText(document.getElementById('linkText').textContent); alert("Copiado!"); }
  
  function openScanner() {
    document.getElementById('configPanel').classList.add('hidden');
    document.getElementById('scannerPanel').classList.remove('hidden');
    document.querySelector('#scannerPanel .btn-secondary').style.display = 'block';
    document.getElementById('instanceLabel').textContent = config.name;
    startConnectionLoop();
  }

  function resetView() {
    clearInterval(qrInterval);
    clearInterval(statusInterval);
    document.getElementById('scannerPanel').classList.add('hidden');
    document.getElementById('configPanel').classList.remove('hidden');
    document.getElementById('qrContainer').innerHTML = '<div style="color: #666;">ðŸ”„ Reiniciando...</div>';
  }

  async function startConnectionLoop() {
    await fetchQRCode();
    checkConnectionStatus();
    
    qrInterval = setInterval(() => {
      timeLeft--;
      document.getElementById('timerBar').style.width = (timeLeft / 30) * 100 + '%';
      if (timeLeft <= 0) { timeLeft = 30; fetchQRCode(); }
    }, 1000);

    // Checa status a cada 3 segundos
    statusInterval = setInterval(checkConnectionStatus, 3000);
  }

  async function fetchQRCode() {
    const qrBox = document.getElementById('qrContainer');
    try {
      // POST /instance/connect
      const response = await fetch(`${config.url}/instance/connect`, {
        method: 'POST',
        headers: { 'token': config.token, 'Content-Type': 'application/json' },
        body: JSON.stringify({})
      });
      
      // Se der erro no POST, mostramos no debug
      if (!response.ok) {
         document.getElementById('realTimeStatus').innerText = `Erro QR: ${response.status}`;
         return;
      }

      const data = await response.json();
      
      // Checagem extra de seguranÃ§a: Se a resposta do QR Code disser que jÃ¡ estÃ¡ conectado
      if (data.instance && (data.instance.state === 'open' || data.instance.status === 'open')) {
          handleConnected();
          return;
      }

      const base64 = data.base64 || data.qrcode || (data.instance ? data.instance.qrcode : null);

      if (base64) {
        const cleanBase64 = base64.replace(/^data:image\/png;base64,/, '');
        qrBox.innerHTML = `<img src="data:image/png;base64,${cleanBase64}" class="qr-img" />`;
        document.getElementById('statusBadge').textContent = "ðŸŸ¡ Escaneie o QR Code";
        document.getElementById('statusBadge').className = "status-badge waiting";
      }
    } catch (error) { console.error(error); }
  }

  async function checkConnectionStatus() {
    const debugLine = document.getElementById('realTimeStatus');
    try {
      // GET /instance/status
      const response = await fetch(`${config.url}/instance/status`, {
        method: 'GET',
        headers: { 'token': config.token }
      });

      if (!response.ok) {
        debugLine.innerText = `Status API: Erro HTTP ${response.status}`;
        debugLine.style.color = '#ef4444';
        return;
      }

      const data = await response.json();
      
      // Tenta capturar o status em qualquer lugar possÃ­vel do JSON
      const state = (data.instance && data.instance.state) || 
                    (data.instance && data.instance.status) || 
                    data.status || 
                    data.state || 
                    "desconhecido";

      // Mostra na tela o que a API estÃ¡ respondendo
      debugLine.innerText = `Status API: ${state}`;
      debugLine.style.color = (state === 'open' || state === 'connected') ? '#4ade80' : '#888';

      // Se for um dos status de sucesso, finaliza
      if (['open', 'connected', 'authenticated'].includes(state)) {
        handleConnected();
      }

    } catch (error) {
      debugLine.innerText = "Status API: Falha de Rede";
    }
  }

  function handleConnected() {
    clearInterval(qrInterval);
    clearInterval(statusInterval);
    
    document.getElementById('qrContainer').innerHTML = `
      <div style="font-size: 4rem;">âœ…</div>
      <h3 style="color:#333; margin:10px 0 0 0;">Conectado!</h3>
    `;
    document.getElementById('statusBadge').textContent = "ðŸŸ¢ WhatsApp Sincronizado";
    document.getElementById('statusBadge').className = "status-badge connected";
    document.getElementById('timerBar').style.width = '100%';
    document.getElementById('timerBar').style.background = '#4ade80';
    document.getElementById('realTimeStatus').innerText = "Status API: ConexÃ£o Confirmada";
  }
</script>
</body>
</html>